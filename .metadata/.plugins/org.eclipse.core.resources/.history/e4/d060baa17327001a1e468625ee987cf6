package com.meli.bill.service;

import java.sql.Timestamp;
import java.util.List;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.meli.bill.DateHelper;
import com.meli.bill.model.Bill;
import com.meli.bill.model.to.ChargeTO;
import com.meli.bill.repository.BillRepository;


@Service
public class BillService {

	@Autowired
	private BillRepository billRepo;

	public Bill getBillByUserMonthYear(Integer userId, Integer month, Integer year) {
		List<Bill> bills = billRepo.findByUserIdMonthYear(userId, month, year);
		if(bills.isEmpty()) {
			return null;
		} else if(bills.size() > 1) {
			throw new IllegalStateException(String.format("Existe m치s de una factura para el mes '%d' y a침o '%d' asociada al usuario '%d'", month, year, userId));
		} else {
			return bills.iterator().next();
		}
	}

	public List<Bill> getBills(Integer user_id) {
		return billRepo.findByUserId(user_id);
	}

	public void addChargeToBill(ChargeTO chargeTO) {
		Timestamp now = DateHelper.getInstance().getNow();
		Integer month = DateHelper.getInstance().getMonth(now);
		Integer year = DateHelper.getInstance().getYear(now);
		billRepo.findByUserIdMonthYear(chargeTO.getUserId(), month, year);
		if(bill == null) {
			bill = new Bill(charge.getUserId(), month, year);
		}
		
		
		// TODO Auto-generated method stub
	}

	private Bill getBillByUserMonthYear(Integer userId, Integer month, Integer year) {
		List<Bill> bills = billRepo.findByUserIdMonthYear(userId, month, year);
		if(bills.isEmpty()) {
			return null;
		} else if(bills.size() > 1) {
			throw new IllegalStateException(String.format("Existe m치s de una factura para el mes '%d' y a침o '%d' asociada al usuario '%d'", month, year, userId));
		} else {
			return bills.iterator().next();
		}
	}

}